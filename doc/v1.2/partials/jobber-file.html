<section>
  <h2>Defining Jobs</h2>

  <p>
    As with cron, each user can have its own set of jobs, which will be run
    under that user&rsquo;s privileges. A user&rsquo;s jobs are defined in a
    <dfn>jobfile</dfn>
    &mdash; a file named &ldquo;.jobber&rdquo; in the user&rsquo;s home
    directory. Here's an example that defines two jobs:
  </p>

  <pre>[prefs]
  notifyProgram: /home/foobar/handleError.sh

[jobs]
- name: DailyBackup
  cmd: backup daily
  time: 0 0 13
  onError: Stop
  notifyOnError: true
  notifyOnFailure: false

- name: OffsiteBackup
  cmd: |
    mount /backup/offsite
    mount /backup/linux/weekly
    backup-offsite /backup/linux/weekly/backup-0 linux || exit 1
    umount /backup/linux/weekly
    umount /backup/offsite
  time: 0 0 14 * * 1
  onError: Stop</pre>

  <p>
    As shown, there are two sections:
    <code>prefs</code>
    and
    <code>jobs</code>
    . The contents of both sections are <a href="http://www.yaml.org/">YAML</a>
    documents.
  </p>

  <aside>
    <p>
      If you&rsquo;re unfamiliar with YAML: The document in the
      <code>prefs</code>
      section contains a mapping with a single entry. The document in the
      <code>jobs</code>
      section contains a sequence of two mappings: the two line-initial dashes (
      <code>-</code>
      ) mark the beginnings of the two mappings. Within the definition of a
      particular map, each key (e.g.,
      <code>name</code>
      ,
      <code>cmd</code>
      ) must be column-aligned. The value for each key in the maps is a string.
      In this example, the value for the key
      <code>cmd</code>
      in the second map is a multi-line string.
    </p>
  </aside>

  <h4>
    Section
    <code>prefs</code>
  </h4>

  <p>This section sets general preferences for how Jobber runs this
    user&rsquo;s jobs. At this time, there is only one valid field.</p>

  <table class="table">
    <thead>
      <tr>
        <th>Field</th>
        <th>Value</th>
        <th>Default Value</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>notifyProgram</code></td>
        <td>
          <p>A path to an executable file.</p>

          <p>
            When this field is set, jobs that notify on error or failure do so
            by executing the specified file. See <a href="#error-handling">below</a>
            for details.
          </p>

          <p>When it is not set, they notify by sending an email to the
            owning user, using sendmail.</p>
        </td>
        <td>None.</td>
      </tr>
    </tbody>
  </table>


  <h4>
    Section
    <code>jobs</code>
  </h4>

  <p>This section defines the user&rsquo;s jobs.</p>

  <p>As stated above, this section must contain a YAML file that defines a
    sequence of mappings. Each mapping in this sequence defines a job.</p>

  <p>The fields of a job definition:</p>
  <table class="table">
    <thead>
      <tr>
        <th>Field</th>
        <th>Value</th>
        <th>Default Value</th>
      </tr>
    </thead>
    <tfoot></tfoot>
    <tbody>
      <tr>
        <td><code>name</code></td>
        <td>The name of the job.</td>
        <td>N/A</td>
      </tr>
      <tr>
        <td><code>cmd</code></td>
        <td>A shell script that is executed when this job runs. Jobber will
          use the shell at /bin/sh.</td>
        <td>N/A</td>
      </tr>
      <tr>
        <td><code>time</code></td>
        <td>A string specifying when the job should run. See <a
          href="#time-strings">below</a> for details.
        </td>
        <td><code>* * * * * *</code></td>
      </tr>
      <tr>
        <td><code>onError</code></td>
        <td>A string (<code>Stop</code>, <code>Backoff</code>, or <code>Continue</code>)
          specifying what should happen when the job has an error. See <a
          href="#error-handling">below</a> for details.
        </td>
        <td><code>Continue</code></td>
      </tr>
      <tr>
        <td><code>notifyOnError</code></td>
        <td>A string (<code>true</code> or <code>false</code>) specifying
          whether jobberd should notify when the job has an error. See <a
          href="#error-handling">below</a> for details.
        </td>
        <td><code>false</code></td>
      </tr>
      <tr>
        <td><code>notifyOnFailure</code></td>
        <td>A string (<code>true</code> or <code>false</code>) specifying
          whether jobberd should notify when the job fails. See <a
          href="#error-handling">below</a> for details.
        </td>
        <td><code>true</code></td>
      </tr>
    </tbody>
  </table>

  <h5 id="time-strings">Time Strings</h5>

  <p>
    Field
    <code>time</code>
    specifies the schedule at which a job is run, in a manner similar to how
    cron jobs&rsquo; schedules are specified: with a space-separated list of up
    to six specifiers, each one of which constrains a different component of
    time (second, minute, hour, etc.). Schematically:
  </p>

  <blockquote>
    <code>sec min hour month_day month week_day</code>
  </blockquote>

  <p>
    <strong>A job is scheduled thus:</strong> it will run at any time that
    satisfies all of the specifiers sec, min, hour, and month and one of the
    specifiers month_day and week_day.
  </p>

  <p>Each specifier can take one of the following forms: (&ldquo;a&rdquo;,
    &ldquo;b&rdquo;, &ldquo;c&rdquo;, and &ldquo;n&rdquo; are placeholders for
    arbitrary numerals.)</p>

  <table class="table">
    <thead>
      <tr>
        <th>Specifier Form</th>
        <th>What It Matches</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>*</code></td>
        <td>Any value</td>
      </tr>
      <tr>
        <td><code>a</code></td>
        <td>The value a</td>
      </tr>
      <tr>
        <td><code>*/n</code></td>
        <td>Every n-th value &mdash; e.g., <code>*/25</code> in the sec
          specifier would match 0, 25, and 50, whereas in the month specifier it
          would match 1 and 26.
        </td>
      </tr>
      <tr>
        <td><code>a,b,c,...</code></td>
        <td>The values a, b, c, ...</td>
      </tr>
      <tr>
        <td><code>a-b</code></td>
        <td>Any of the values between and including a and b</td>
      </tr>
    </tbody>
  </table>

  <p>The specifiers have different permitted values for the placeholders in
    the specifier forms:</p>

  <table class="table">
    <thead>
      <tr>
        <th>Specifier</th>
        <th>Values for &ldquo;a&rdquo;, &ldquo;b&rdquo;, and
          &ldquo;c&rdquo;</th>
        <th>Values for &ldquo;n&rdquo;</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>sec</td>
        <td><code>0</code> thru <code>59</code></td>
        <td><code>1</code> thru <code>59</code></td>
      </tr>
      <tr>
        <td>min</td>
        <td><code>0</code> thru <code>59</code></td>
        <td><code>1</code> thru <code>59</code></td>
      </tr>
      <tr>
        <td>hour</td>
        <td><code>0</code> thru <code>23</code></td>
        <td><code>1</code> thru <code>23</code></td>
      </tr>
      <tr>
        <td>month_day</td>
        <td><code>1</code> thru <code>31</code></td>
        <td><code>1</code> thru <code>30</code></td>
      </tr>
      <tr>
        <td>month</td>
        <td><code>1</code> thru <code>12</code></td>
        <td><code>1</code> thru <code>11</code></td>
      </tr>
      <tr>
        <td>week_day</td>
        <td><code>0</code> thru <code>6</code></td>
        <td><code>1</code> thru <code>5</code></td>
      </tr>
    </tbody>
  </table>

  <aside>
    <p>
      <strong>NOTE:</strong> Because in a YAML document
      <code>*</code>
      has a special meaning at the beginning of an item, if your time string
      starts with
      <code>*</code>
      you must quote the whole string, thus:
      <code>time: '*/10'</code>
    </p>
  </aside>

  <h4 id="error-handling">Error-handling</h4>

  <p>
    Some terms: When Jobber runs a job and that job exits with a non-0 status,
    we call that a <strong>job error</strong>. When Jobber stops scheduling runs
    of a job due to one or more job errors, we call that a <strong>job
      failure</strong>.
  </p>

  <p>
    In the
    <code>onError</code>
    field in the job&rsquo;s definition, you can control what Jobber does after
    a job error by picking one of these values:
  </p>

  <table class="table">
    <thead>
      <tr>
        <th>Value</th>
        <th>Effect</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>Stop</code></td>
        <td>Stop scheduling runs of this job.</td>
      </tr>
      <tr>
        <td><code>Backoff</code></td>
        <td>Schedule runs of this job according to an exponential backoff
          algorithm. If a later run of the job succeeds, jobber resumes
          scheduling this job normally; but if the job errors again on several
          consecutive runs, Jobber stops scheduling it.</td>
      </tr>
      <tr>
        <td><code>Continue</code></td>
        <td>Continue scheduling this job normally.</td>
      </tr>
    </tbody>
  </table>

  <p>
    If you would like Jobber to notify you when a job errors or fails, first set
    <code>notifyOnError</code>
    or
    <code>notifyOnFailure</code>
    to
    <code>true</code>
    in the job&rsquo;s definition in the Jobber file.
  </p>

  <p>
    Then, write a <em>notify program</em> &mdash; a program that does whatever
    logic you want done after an error or failure. Set the
    <code>notifyProgram</code>
    field in the
    <code>prefs</code>
    section of the Jobber file to the path to your notify program.
  </p>

  <p>When Jobber calls your notify program, it will write to stdin a JSON
    document like this:</p>

  <pre>{  
   "job":{  
      "command":"/home/dylan/some_program",
      "name":"MyHourlyJob",
      "notifyOnError":true,
      "notifyOnFailure":false,
      "onError":"Stop",
      "status":"Failed",
      "time":"0 0 * * * *"
   },
   "startTime":"May 29 15:25:10 2017",
   "stderr":"Some errors\n",
   "stderr_base64":false,
   "stdout":"Quotes: \"adf\"\n",
   "stdout_base64":false,
   "succeeded":false,
   "user":"dylan"
}</pre>

  <p>
    The fields in the
    <code>job</code>
    object are from the job&rsquo;s definition, except for
    <code>status</code>
    , which contains
    <code>Good</code>
    ,
    <code>Backoff</code>
    , or
    <code>Failed</code>
    .
  </p>

  <p>
    <code>stdout</code>
    (respectively,
    <code>stderr</code>
    ) contains whatever the job wrote to stdout (stderr). If
    <code>stdout_base64</code>
    contains
    <code>true</code>
    , then the job wrote only UTF-8 bytes to stdout (stderr), and
    <code>stdout</code>
    (
    <code>stderr</code>
    ) contains a string with those bytes; otherwise, there were some non-UTF-8
    bytes and
    <code>stdout</code>
    (
    <code>stderr</code>
    ) contains a Base64 encoding of the output.
  </p>
</section>